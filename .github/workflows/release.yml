name: release
on:
  push:
    tags:
      - "v*.*.*"

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true

jobs:
  tag-check:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - name: Validate tag matches Cargo.toml version
        shell: bash
        run: |
          set -euo pipefail
          [[ "${GITHUB_REF_TYPE}" == "tag" ]] || { echo "Not a tag"; exit 1; }
          [[ "${GITHUB_REF_NAME}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[0-9A-Za-z.-]+)?$ ]] || { echo "Tag format invalid"; exit 1; }
          tag_ver="${GITHUB_REF_NAME#v}"
          cargo_ver="$(grep -m1 '^version' crates/skillpack/Cargo.toml | sed -E 's/version *= *"([^"]+)".*/\1/')"
          [[ "${tag_ver}" == "${cargo_ver}" ]] || { echo "Tag ${tag_ver} != Cargo.toml ${cargo_ver}"; exit 1; }

  build:
    needs: tag-check
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 45
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: ubuntu-24.04
            target: x86_64-unknown-linux-gnu
          - runner: macos-15-intel
            target: x86_64-apple-darwin
          - runner: macos-26
            target: aarch64-apple-darwin
          - runner: windows-latest
            target: x86_64-pc-windows-msvc

    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      - uses: Swatinem/rust-cache@v2
      - name: Build
        shell: bash
        run: cargo build -p skillpack --bin sp --release --target ${{ matrix.target }}

      - name: Stage artifact
        shell: bash
        run: |
          set -euo pipefail
          dest="dist/${{ matrix.target }}"
          mkdir -p "$dest"
          if [[ "${{ matrix.target }}" == *windows* ]]; then
            cp "target/${{ matrix.target }}/release/sp.exe" "$dest/sp-${{ matrix.target }}.exe"
          else
            cp "target/${{ matrix.target }}/release/sp" "$dest/sp-${{ matrix.target }}"
          fi

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.target }}
          path: dist/${{ matrix.target }}/*

  release:
    needs: build
    runs-on: ubuntu-24.04
    permissions:
      contents: write
    outputs:
      version: ${{ steps.release_meta.outputs.version }}
      should_publish_npm: ${{ steps.release_meta.outputs.should_publish_npm }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Release metadata
        id: release_meta
        shell: bash
        run: |
          set -euo pipefail
          version="${GITHUB_REF_NAME#v}"
          echo "version=${version}" >> "$GITHUB_OUTPUT"
          if [[ "${version}" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "should_publish_npm=true" >> "$GITHUB_OUTPUT"
          else
            echo "should_publish_npm=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Build npm tarball
        shell: bash
        run: |
          set -euo pipefail
          version="${{ steps.release_meta.outputs.version }}"
          pushd npm/skillpack
          npm version "${version}" --no-git-tag-version
          npm pack
          popd
          mkdir -p dist/npm
          tgz="npm/skillpack/nikhilp0-skillpack-${version}.tgz"
          if [[ ! -f "${tgz}" ]]; then
            tgz="npm/skillpack/skillpack-${version}.tgz"
          fi
          cp "${tgz}" "dist/npm/skillpack-npm-${version}.tgz"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ steps.release_meta.outputs.version }}
          tag_name: ${{ github.ref_name }}
          files: dist/**
          prerelease: ${{ contains(steps.release_meta.outputs.version, '-') }}

  publish-npm:
    if: ${{ needs.release.outputs.should_publish_npm == 'true' }}
    needs: release
    runs-on: ubuntu-24.04
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          registry-url: "https://registry.npmjs.org"
          scope: "@nikhilp0"

      - name: Update npm
        run: npm install -g npm@latest

      - name: Download npm tarball from release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ needs.release.outputs.version }}
          TAG: ${{ github.ref_name }}
        run: |
          set -euo pipefail
          mkdir -p dist/npm
          gh release download "${TAG}" \
            --repo "${GITHUB_REPOSITORY}" \
            --pattern "skillpack-npm-${VERSION}.tgz" \
            --dir dist/npm

      - name: Publish npm package
        env:
          VERSION: ${{ needs.release.outputs.version }}
        run: |
          set -euo pipefail
          npm publish "dist/npm/skillpack-npm-${VERSION}.tgz" --access public
